name: master

on:
   push:
      paths-ignore:
         - 'doc/**'
         - 'documentation/**'
         - '*.md'
         - '*.yml'
         - '.github/workflows/**'
      branches:
         - master

# This will prevent multiple parallel runs, and will a cancel queued runs except the latest one.
concurrency:
   group: 'master-ci'
   # Allow any already started jobs to finish, so we don't leave snapshot builds in a broken state.
   cancel-in-progress: false

permissions:
   contents: read

jobs:

   validate-api:
      name: Validate API
      if: github.repository == 'kotest/kotest'
      uses: ./.github/workflows/run-gradle.yml
      secrets: inherit
      with:
         runs-on: ubuntu-latest
         ref: ${{ inputs.ref }}
         task: apiCheck

   validate-linux:
      name: Validate and publish on primary runner
      if: github.repository == 'kotest/kotest'
      uses: ./.github/workflows/run-gradle.yml
      needs: validate-api
      secrets: inherit
      with:
         runs-on: ubuntu-latest
         ref: ${{ inputs.ref }}
         task: check publishToAppropriateCentralRepository -P"kotest_enableKotlinJs"=true -P"kotest_enableKotlinNative"=true

   validate-macos:
      name: Validate and publish on macos
      if: github.repository == 'kotest/kotest'
      needs: [ validate-api, validate-linux ]
      uses: ./.github/workflows/run-gradle.yml
      secrets: inherit
      with:
         runs-on: macos-latest
         ref: ${{ inputs.ref }}
         task: check publishToAppropriateCentralRepository -P"kotest_enableKotlinJs"=false -P"kotest_enableKotlinNative"=true

   validate-windows:
      name: Validate and publish on windows
      if: github.repository == 'kotest/kotest'
      needs: [ validate-api, validate-linux ]
      uses: ./.github/workflows/run-gradle.yml
      secrets: inherit
      with:
         runs-on: windows-latest
         ref: ${{ inputs.ref }}
         task: check publishToAppropriateCentralRepository -P"kotest_enableKotlinJs"=false -P"kotest_enableKotlinNative"=true
