name: master

on:
   push:
      paths-ignore:
         - 'doc/**'
         - 'documentation/**'
         - '*.md'
         - '*.yml'
         - '.github/workflows/**'
      branches:
         - master

permissions:
   contents: read

jobs:

   validate-api:
      name: Validate API
      if: github.repository == 'kotest/kotest'
      uses: ./.github/workflows/run-gradle.yml
      with:
         runs-on: ubuntu-latest
         ref: ${{ inputs.ref }}
         task: apiCheck

   validate-primary-regular:
      name: Regular tests on primary runner
      if: github.repository == 'kotest/kotest'
      needs: validate-api
      uses: ./.github/workflows/run-gradle.yml
      with:
         runs-on: ubuntu-latest
         ref: ${{ inputs.ref }}
         task: check -Dkotest.tags=!Deprecated

   validate-primary-deprecated:
      name: Deprecated tests on primary runner
      if: github.repository == 'kotest/kotest'
      needs: [ validate-api, validate-primary ]
      uses: ./.github/workflows/run-gradle.yml
      with:
         runs-on: ubuntu-latest
         ref: ${{ inputs.ref }}
         task: check -Dkotest.tags=Deprecated

   validate-secondary-regular:
      name: Regular tests on secondary runners
      if: github.repository == 'kotest/kotest'
      needs: [ validate-api, validate-primary ]
      strategy:
         matrix:
            os: [ macos-latest, windows-latest ]
         fail-fast: false
      uses: ./.github/workflows/run-gradle.yml
      with:
         runs-on: ${{ matrix.os }}
         ref: ${{ inputs.ref }}
         task: check -Dkotest.tags=!Deprecated

   validate-secondary-deprecated:
      name: Deprecated tests on secondary runners
      if: github.repository == 'kotest/kotest'
      needs: [ validate-api, validate-primary ]
      strategy:
         matrix:
            os: [ macos-latest, windows-latest ]
         fail-fast: false
      uses: ./.github/workflows/run-gradle.yml
      with:
         runs-on: ${{ matrix.os }}
         ref: ${{ inputs.ref }}
         task: check -Dkotest.tags=Deprecated

   publish-sonatype:
      name: Publish all artifacts to Sonatype (Maven Central)
      if: github.repository == 'kotest/kotest'
      needs: [ validate-api, validate-primary-regular, validate-secondary-regular ]
      uses: ./.github/workflows/run-gradle.yml
      secrets: inherit
      with:
         runs-on: macos-latest
         ref: ${{ inputs.ref }}
         task: publishAllPublicationsToDeployRepository
