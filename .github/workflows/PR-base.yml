name: PR-base
# Triggers Docs PR workflow on changes to documentation
# Triggers tests on non-docs PRs

on:
   merge_group:
   pull_request:

permissions:
   contents: read

jobs:
   determine-workflows-to-run:
      name: Determine workflows to run
      runs-on: ubuntu-latest
      outputs:
         run_docs: ${{ steps.check_files.outputs.run_docs }}
         run_tests: ${{ steps.check_files.outputs.run_tests }}
      steps:
         -  name: Checkout code
            uses: actions/checkout@v2
            with:
               fetch-depth: 2

         -  name: check modified files
            id: check_files
            run: |
               echo "run_docs=false" >> $GITHUB_OUTPUT
               echo "run_tests=false" >> $GITHUB_OUTPUT

               echo "=============== list modified files ==============="
               git diff --name-only HEAD^ HEAD

               echo "========== check paths of modified files =========="
               git diff --name-only HEAD^ HEAD > files.txt
               while IFS= read -r file
               do
                 echo $file
                 if [[ $file != documentation/* ]]; then
                   echo "This modified file is not under the 'documentation' folder. Will run tests."
                   echo "run_tests=true" >> $GITHUB_OUTPUT
                 else
                   echo "This modified file is under the 'documentation' folder. Will run docs workflow."
                   echo "run_docs=true" >> $GITHUB_OUTPUT
                 fi
               done < files.txt
   run-docs:
      name: Run docs
      needs: determine-workflows-to-run
      if: ${{ needs.determine-workflows-to-run.outputs.run_docs == 'true' }}
      uses: ./.github/workflows/docs_pr.yml
      with:
         ref: ${{ github.event.inputs.ref }}
   run-tests:
      name: Run tests
      needs: determine-workflows-to-run
      if: ${{ needs.determine-workflows-to-run.outputs.run_tests == 'true' }}
      uses: ./.github/workflows/PR.yml
      with:
         ref: ${{ github.event.inputs.ref }}
