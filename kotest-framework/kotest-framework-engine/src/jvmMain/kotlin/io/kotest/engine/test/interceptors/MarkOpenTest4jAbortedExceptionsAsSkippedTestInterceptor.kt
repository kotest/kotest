package io.kotest.engine.test.interceptors

import io.kotest.common.JVMOnly
import io.kotest.core.test.TestCase
import io.kotest.core.test.TestScope
import io.kotest.engine.test.TestResult
import org.opentest4j.TestAbortedException
import org.opentest4j.TestSkippedException

/**
 * [TestAbortedException] and [TestSkippedException] are exceptions from the OpenTest4j project that can be used
 * to mark a test as ignored (aborted). This interceptor catches such exceptions and converts the result
 * to an [io.kotest.engine.test.TestResult.Ignored].
 */
@JVMOnly
internal object MarkOpenTest4jAbortedExceptionsAsSkippedTestInterceptor : TestExecutionInterceptor {
   override suspend fun intercept(
      testCase: TestCase,
      scope: TestScope,
      test: NextTestExecutionInterceptor
   ): TestResult {
      return test(testCase, scope).let { testResult ->
         when (val error = testResult.errorOrNull) {
            is TestAbortedException -> TestResult.Ignored(error.message)
            is TestSkippedException -> TestResult.Ignored(error.message)
            else -> testResult
         }
      }
   }
}
