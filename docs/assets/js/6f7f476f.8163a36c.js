"use strict";(self.webpackChunkkotestdocs=self.webpackChunkkotestdocs||[]).push([[84270],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>u});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),m=c(n),u=a,h=m["".concat(l,".").concat(u)]||m[u]||d[u]||i;return n?o.createElement(h,s(s({ref:t},p),{},{components:n})):o.createElement(h,s({ref:t},p))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,s=new Array(i);s[0]=m;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:a,s[1]=r;for(var c=2;c<i;c++)s[c]=n[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},91971:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>c});var o=n(87462),a=(n(67294),n(3905));const i={id:"test_containers",title:"Testcontainers",sidebar_label:"Testcontainers",slug:"test_containers.html"},s=void 0,r={unversionedId:"extensions/test_containers",id:"version-6.1/extensions/test_containers",title:"Testcontainers",description:"Testcontainers",source:"@site/versioned_docs/version-6.1/extensions/test_containers.md",sourceDirName:"extensions",slug:"/extensions/test_containers.html",permalink:"/docs/extensions/test_containers.html",draft:!1,editUrl:"https://github.com/kotest/kotest/blob/master/documentation/versioned_docs/version-6.1/extensions/test_containers.md",tags:[],version:"6.1",frontMatter:{id:"test_containers",title:"Testcontainers",sidebar_label:"Testcontainers",slug:"test_containers.html"},sidebar:"extensions",previous:{title:"System Extensions",permalink:"/docs/extensions/system_extensions.html"},next:{title:"WireMock",permalink:"/docs/extensions/wiremock.html"}},l={},c=[{value:"Testcontainers",id:"testcontainers",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Generic Containers",id:"generic-containers",level:2},{value:"Databases",id:"databases",level:2},{value:"Compose Containers",id:"compose-containers",level:2},{value:"Container Logs",id:"container-logs",level:2}],p={toc:c};function d(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"testcontainers"},"Testcontainers"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://central.sonatype.com/artifact/io.kotest/kotest-extensions-testcontainers"},(0,a.kt)("img",{src:"https://img.shields.io/maven-central/v/io.kotest/kotest-extensions-testcontainers.svg?label=latest%20release"})),"\n",(0,a.kt)("a",{parentName:"p",href:"https://central.sonatype.com/repository/maven-snapshots/io/kotest/kotest-extensions-testcontainers/maven-metadata.xml"},(0,a.kt)("img",{src:"https://img.shields.io/maven-metadata/v?metadataUrl=https%3A%2F%2Fcentral.sonatype.com%2Frepository%2Fmaven-snapshots%2Fio%2Fkotest%2Fkotest-extensions-testcontainers%2Fmaven-metadata.xml"}))),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"This documentation is for the latest release of the Testcontainers module and is compatible with Kotest 6.0+.")),(0,a.kt)("p",null,"The ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/testcontainers/testcontainers-java"},"Testcontainers")," project provides lightweight, ephemeral\ninstances of common databases, Elasticsearch, Kafka, Redis, or anything else that can run in a Docker container - ideal\nfor use inside tests."),(0,a.kt)("p",null,"Kotest provides integration with ",(0,a.kt)("inlineCode",{parentName:"p"},"Testcontainers")," through an additional module which provides support for:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GenericContainer"),"'s"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ComposeContainer"),"s"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"JDBC")," compatible databases")),(0,a.kt)("h2",{id:"dependencies"},"Dependencies"),(0,a.kt)("p",null,"To begin, add the following dependency to your Gradle build file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"io.kotest:kotest-extensions-testcontainers:${kotest.version}\n")),(0,a.kt)("p",null,"For Maven, you will need these dependencies:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-xml"},"\n<dependency>\n  <groupId>io.kotest</groupId>\n  <artifactId>kotest-extensions-testcontainers</artifactId>\n  <version>${kotest.version}</version>\n  <scope>test</scope>\n</dependency>\n")),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"Since Kotest 6.0, all extensions are published under the ",(0,a.kt)("inlineCode",{parentName:"p"},"io.kotest")," group with version cadence tied to the main Kotest\nreleases.")),(0,a.kt)("h2",{id:"generic-containers"},"Generic Containers"),(0,a.kt)("p",null,"Kotest provides two ",(0,a.kt)("inlineCode",{parentName:"p"},"GenericContainer")," extensions - ",(0,a.kt)("inlineCode",{parentName:"p"},"TestContainerSpecExtension")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"TestContainerProjectExtension"),"\nwhich can be used to wrap any container and which tie the lifecycle of the container to the lifecycle of the spec or\nproject depending on which extension is used."),(0,a.kt)("p",null,"We can create the extension using either a strongly typed container, or docker image name."),(0,a.kt)("p",null,"Using a strongly typed container:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},"val elasticsearch = install(ContainerExtension(ElasticsearchContainer(ELASTICSEARCH_IMAGE))) {\n  withPassword(ELASTICSEARCH_PASSWORD)\n}\n")),(0,a.kt)("p",null,"Or using a docker image name:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},'val container = install(TestContainerSpecExtension(GenericContainer("redis:5.0.3-alpine"))) {\n  startupAttempts = 2\n  withExposedPorts(6379)\n}\nval jedis = JedisPool(container.host, container.firstMappedPort)\n')),(0,a.kt)("p",null,"The strongly typed container is preferred when one is provided by the ",(0,a.kt)("inlineCode",{parentName:"p"},"Testcontainers")," project, because it gives\naccess to specific settings - such as the ",(0,a.kt)("inlineCode",{parentName:"p"},"password")," option in the elasticsearch example above. However, when a strongly\ntyped container is not available, the former method allows us to fall back to any docker image as a general container."),(0,a.kt)("p",null,"Once the container is installed, you can use the containers's host and port to configure a client to access that\ncontainer. For example, to connect a Jedis client to a Redis container:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},'val container = install(TestContainerSpecExtension(GenericContainer("redis:5.0.3-alpine")))\nval jedis = JedisPool(container.host, container.firstMappedPort)\n')),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Use the ",(0,a.kt)("inlineCode",{parentName:"p"},"TestContainerProjectExtension")," if you want to share the same container across multiple specs in a\nproject for faster startup times.")),(0,a.kt)("h2",{id:"databases"},"Databases"),(0,a.kt)("p",null,"For JDBC compatible databases, Kotest provides the ",(0,a.kt)("inlineCode",{parentName:"p"},"JdbcDatabaseContainerSpecExtension")," and\n",(0,a.kt)("inlineCode",{parentName:"p"},"JdbcDatabaseContainerProjectExtension"),". These return not the container directly, but a ",(0,a.kt)("inlineCode",{parentName:"p"},"javax.sql.DataSource"),", backed\nby an instance of ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/brettwooldridge/HikariCP"},"HikariCP"),", which can be configured during setup."),(0,a.kt)("p",null,"Firstly, create the container."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},'val mysql = MySQLContainer<Nothing>("mysql:8.0.26").apply {\n  startupAttempts = 1\n  withUrlParam("connectionTimeZone", "Z")\n  withUrlParam("zeroDateTimeBehavior", "convertToNull")\n}\n')),(0,a.kt)("p",null,"Secondly, install the container inside an extension, providing an optional configuration lambda for Hikari."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},'val ds = install(JdbcDatabaseContainerSpecExtension(mysql)) {\n  // these are hikari pool config options\n  poolName = "myconnectionpool"\n  maximumPoolSize = 8\n  idleTimeout = 10000\n}\n')),(0,a.kt)("p",null,"If you don't wish to configure the pool, then you can omit the trailing lambda. If you don't want to use Hikari, then\nyou can use the generic extensions instead."),(0,a.kt)("p",null,"Then the datasource can be used in a test. For example, here is a full example of inserting some\nobjects and then retrieving them to test that the insert was successful."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},'class QueryDatastoreTest : FunSpec({\n\n  val mysql = MySQLContainer<Nothing>("mysql:8.0.26").apply {\n    startupAttempts = 1\n    withUrlParam("connectionTimeZone", "Z")\n    withUrlParam("zeroDateTimeBehavior", "convertToNull")\n  }\n\n  val ds = install(JdbcDatabaseContainerSpecExtension(mysql)) {\n    poolName = "myconnectionpool"\n    maximumPoolSize = 8\n    idleTimeout = 10000\n  }\n\n  val datastore = PersonDatastore(ds)\n\n  test("insert happy path") {\n\n    datastore.insert(Person("sam", "Chicago"))\n    datastore.insert(Person("jim", "Seattle"))\n\n    datastore.findAll().shouldBe(\n      listOf(\n        Person("sam", "Chicago"),\n        Person("jim", "Seattle"),\n      )\n    )\n  }\n})\n')),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Use the ",(0,a.kt)("inlineCode",{parentName:"p"},"JdbcDatabaseContainerProjectExtension")," if you want to share the same container across multiple specs in a\nproject for faster startup times.")),(0,a.kt)("h2",{id:"compose-containers"},"Compose Containers"),(0,a.kt)("p",null,"Kotest provides two extensions for ",(0,a.kt)("inlineCode",{parentName:"p"},"ComposeContainer"),"s - ",(0,a.kt)("inlineCode",{parentName:"p"},"ComposeContainerSpecExtension")," and\n",(0,a.kt)("inlineCode",{parentName:"p"},"ComposeContainerProjectExtension"),". This extension can be used to wrap ",(0,a.kt)("inlineCode",{parentName:"p"},"ComposeContainer")," and startup multiple\ncontainers at once defined in a docker compose file."),(0,a.kt)("p",null,"We can create the extension using a ",(0,a.kt)("inlineCode",{parentName:"p"},"File")," pointing to the docker compose file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},'val container = install(ComposeContainerSpecExtension(ComposeContainer(File("my-compose-file.yml"))))\n')),(0,a.kt)("p",null,"Alternative, if our docker compose file is in the resources folder of our project, we can use the following shortcut:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},'// eg for src/main/resources/docker-compose.yml\nval container = install(ComposeContainerSpecExtension.fromResource("docker-compose.yml"))\n')),(0,a.kt)("h2",{id:"container-logs"},"Container Logs"),(0,a.kt)("p",null,"Kotest provides the option to capture the logs from the containers that are started by the extensions and output\nthose in the test console. This can be enabled by passing an instance of ",(0,a.kt)("inlineCode",{parentName:"p"},"ContainerExtensionConfig")," to the extension.\nIn the config instance, set the ",(0,a.kt)("inlineCode",{parentName:"p"},"logConsumer")," option to be ",(0,a.kt)("inlineCode",{parentName:"p"},"StandardLogConsumer"),", specifying the level of logs to\ncapture. For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-kotlin"},"install(\n   TestContainerSpecExtension(\n      container,\n      ContainerExtensionConfig(logConsumer = StandardLogConsumer(LogTypes.ALL))\n   )\n)\n")),(0,a.kt)("p",null,"The log types can be set to capture ",(0,a.kt)("inlineCode",{parentName:"p"},"ALL"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"STDOUT"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"STDERR")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"NONE"),"."))}d.isMDXComponent=!0}}]);